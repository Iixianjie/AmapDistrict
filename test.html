<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>title</title>
    <style>
      body {
        background-color: #fff;
      }

      #container {
        width: 800px;
        height: 800px;
        background-color: transparent !important;
      }

      #container canvas.amap-layer {
        background-color: transparent;
      }
    </style>
  </head>

  <body>
    <div id="container"></div>
    <script
      type="text/javascript"
      src="https://webapi.amap.com/maps?v=1.4.14&key=2f86791f52fd930b054e74c383cd016f&plugin=Map3D,AMap.DistrictSearch"
    ></script>
    <script src="https://webapi.amap.com/ui/1.0/main.js?v=1.0.11"></script>
    <script>
      searchArea('贵阳市', {
        el: 'container',
        showLabel: true,
        areaClick(areaInfo) {
          console.log(areaInfo);
        },
        childrensChange(children) {
          console.log(children);
        }
      });

      // 用于调整特定label的位置
      var fixLabelPosition = [
        {
          label: '南明区',
          position: [40, 20]
        }
      ];

      function fixPosition(name) {
        var index = fixLabelPosition.findIndex(function(v) {
          return name === v.label;
        });

        return index !== -1
          ? new AMap.Pixel(...fixLabelPosition[index].position)
          : new AMap.Pixel(0, 0);
      }

      // 搜索区域
      function searchArea(areaName, options) {
        if (!areaName) return;

        var opts = {
          subdistrict: 1,
          extensions: 'all',
          level: 'city'
        };
        var context = {};

        //利用行政区查询获取边界构建mask路径
        //也可以直接通过经纬度构建mask路径
        var district = new AMap.DistrictSearch(opts);

        district.search(areaName, function(status, result) {
          if (status === 'no_data') {
            alert('没有 ' + areaName + ' 的区域信息');
            return;
          }

          // 存在同名的区时，取52开头的
          var ind = result.districtList.findIndex(v => {
            return /^52/.test(v.adcode);
          });

          var selectedArea = result.districtList[ind];

          var bounds = selectedArea.boundaries;
          var childrens = selectedArea.districtList;

          // 回调返回children
          options.childrensChange && options.childrensChange(childrens);

          var adcode = selectedArea.adcode;

          context.bounds = bounds;
          context.childrens = childrens;
          context.areaCode = adcode;
          context.options = options;
          context.areaCenter = [
            selectedArea.center.lng,
            selectedArea.center.lat
          ];
          createMap(context);
        });
      }

      // 创建地图实例
      function createMap(context) {
        var { bounds, childrens, options, areaCenter } = context;

        // 根据区域bounds生成mask
        var mask = [];
        for (var i = 0; i < bounds.length; i += 1) {
          mask.push([bounds[i]]);
        }

        context.map = new AMap.Map(options.el, {
          mapStyle: 'amap://styles/darkblue',
          mask: mask,
          viewMode: '3D',
          skyColor: 'transparent',  // 去掉天空颜色
          pitch: 40,  // 倾角
          showLabel: true,
          resizeEnable: true,
          center: areaCenter,
          zooms: [9.5, 14],
          zoom: 9.5
        });

        createTextLabel(context);
      }

      // 创建地图上的文字
      function createTextLabel(context) {
        var { childrens, map, options } = context;

        if (options.showLabel) {
          childrens.forEach(function(v) {
            var position = [v.center.lng, v.center.lat];

            var text = new AMap.Text({
              text: v.name,
              clickable: true,
              angle: 0,
              autoRotation: true,
              cursor: 'pointer',
              angle: 0,
              // 南明区和云岩区的文字重叠了
              offset: fixPosition(v.name),
              extData: {
                id: 123,
                name: v.name
              },
              style: {
                'background-color': 'rgba(255,255,255,0.9)',
                'font-size': '12px',
                border: 'none',
                color: '#333'
              },
              position: position,
              map: map
            });

            text.on('click', function({ target }) {
              map.setCenter(position);
              let zoom = map.getZoom();
              if(!window.zoom) {
                window.zoom = zoom + 1;
              }
              map.setZoom(window.zoom);
              options.areaClick && options.areaClick(target.B.extData);
            });
          });
        }

        // 隐藏地图和文字label外的其他地图信息
        map.setFeatures(['bg', 'point']);

        areaHeightLight(context);
      }

      // 区域上色、创建掩模、限制可视区域
      function areaHeightLight(context) {
        var { map, bounds, areaCode } = context;

        console.log(bounds);
        // 用于设置区域的颜色
        var colors = [
          '#ffa39e',
          '#ffbb96',
          '#ffd591',
          '#ffe58f',
          '#fffb8f',
          '#eaff8f',
          '#b7eb8f',
          '#87e8de',
          '#91d5ff',
          '#adc6ff',
          '#d3adf7',
          '#ffadd2'
        ];

        AMapUI.loadUI(['geo/DistrictExplorer'], function(DistrictExplorer) {
          //创建一个实例
          var districtExplorer = new DistrictExplorer({
            map: map
          });

          districtExplorer.loadAreaNode(areaCode, function(error, areaNode) {
            //更新地图视野
            map.setBounds(areaNode.getBounds(), null, null, true);

            //清除已有的绘制内容
            districtExplorer.clearFeaturePolygons();

            //绘制子区域
            districtExplorer.renderSubFeatures(areaNode, function(feature, i) {
              var fillColor = colors[i % colors.length];
              var strokeColor = colors[colors.length - 1 - (i % colors.length)];

              return {
                cursor: 'default',
                bubble: true,
                strokeColor: strokeColor, //线颜色
                strokeOpacity: 1, //线透明度
                strokeWeight: 1, //线宽
                fillColor: fillColor, //填充色
                fillOpacity: 0.35 //填充透明度
              };
            });

            //绘制父区域
            districtExplorer.renderParentFeature(areaNode, {
              cursor: 'default',
              bubble: true,
              strokeColor: 'black', //线颜色
              strokeOpacity: 1, //线透明度
              strokeWeight: 1, //线宽
              fillColor: null, //填充色
              fillOpacity: 0.35 //填充透明度
            });
          });

        });

        // 添加掩模
        var object3Dlayer = new AMap.Object3DLayer({ zIndex: 1 });

        map.add(object3Dlayer);
        var height = -8000;
        var color = '#0088ffcc'; //rgba
        var wall = new AMap.Object3D.Wall({
          path: bounds,
          height: height,
          color: color
        });
        wall.transparent = true;
        object3Dlayer.add(wall);
        //添加描边
        for (var i = 0; i < bounds.length; i += 1) {
          new AMap.Polyline({
            path: bounds[i],
            strokeColor: '#99ffff',
            strokeWeight: 4,
            map: map
          });
        }

        // 限制可视区域
        var _bounds = map.getBounds();
        map.setLimitBounds(_bounds);
      }
    </script>
  </body>
</html>
